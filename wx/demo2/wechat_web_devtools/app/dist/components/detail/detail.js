"use strict";function init(){function e(e){var t=e?new Date(e):new Date;return t.toLocaleDateString()+" "+t.toLocaleTimeString()}var t=require("../../lib/react.js"),s=require("../../cssStr/cssStr.js"),a=(require("../../utils/tools.js"),require("../../weapp/commit/upload.js")),r=require("../../actions/projectActions.js"),i=require("../../common/log/log.js"),o=require("../../utils/newReport.js"),l=(require("../../stores/webviewStores.js"),require("../../stores/windowStores.js")),c=require("../../config/errcodeConfig.js"),n=require("../../actions/windowActions.js"),p=require("../../stores/projectStores.js"),d=require("./uploadInfo.js"),m=function(e){n.showTipsMsg({msg:e,type:"error"})},h=function(e,t){n.showConfirm({content:e,callback:t})},u=t.createClass({displayName:"Detail",getInitialState:function(){var e=this.props.project,t=e.isTourist,s=localStorage["last-up-test-time-"+e.hash],a=localStorage["last-up-load-time-"+e.hash];return{lastUploadTime:t?"项目未关联AppID":a?a:"未上传",lastTestTime:t?"项目未关联AppID":s?s:"未提交",testBtnClass:"detail-meta-upload",testBtnTitle:"预览",qrcode_img:"",isTourist:t,es6:e.es6,minified:e.minified,watcher:e.watcher}},closeImg:function(){this.setState({qrcode_img:""})},upload:function(){var e=this.props.project,t=e.isTourist;t||this.refs.uploadWnd.startUpload()},delProject:function(){var e=this;h("确认删除 "+decodeURIComponent(this.props.project.appname)+" ?",function(t){if(t){var s=e.props.project.appid;r.del(e.props.project.projectid),delete localStorage["last-up-test-time-"+e.props.project.hash],delete localStorage["last-up-load-time-"+e.props.project.hash],o("project_delete",s)}})},uploadForTest:function(e){var t=this,s=this.props.project,r=s.isTourist;r||this.lock||(this.setState({testBtnClass:"detail-upload-dialog-button-primary detail-upload-dialog-button-primary-loading",testBtnTitle:"上传中"}),this.lock=!0,a.uploadForTest(this.props.project,{},function(e,s,a,r){t.getResp({error:e,resp:s,res:a,options:r,type:"test"})}))},getResp:function(t){this.lock=!1;var s=t.error,a=(t.resp,t.res),r=t.type,o=t.options,l={testBtnClass:"detail-meta-upload",testBtnTitle:"预览"};if(s){var n="string"==typeof s?s:s.msg;m(n||"提交预览出错，请去调试窗口编译代码，查看详细错误信息"),this.setState(l)}else{try{a=JSON.parse(a)}catch(p){return m("系统错误，上传回包："+a),void this.setState(l)}var d=a.baseresponse,h=d?parseInt(d.errcode):0,u=parseInt(a.wxpkg_size/1024);if(h===c.DEV_App_Not_Band)return m("当前开发者未绑定此 appid ，请到 mp 后台操作后重试"),nw.Shell.openExternal("https://mp.weixin.qq.com/"),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_Need_Admin)return m("需要管理员才能进行上传操作，请检查后重试"),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_Need_SCAN_CODE)return m("请重新扫码确认"),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_COMPILE_EMPTY_SOURCE)return m("代码包为空，请检查后重试"),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_COMPILE_WXPKG_MAX_LIMIT)return m("编译包大小为 "+u+" kb，超过限制 "+(u-o.MAX_APP_LENGTH)+" kb，请删除文件后重试"),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_COMPILE_INVALID_WXPKG)return m("代码包错误，错误代码 "+h),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_COMPILE_WXML_FAIL)return m("wxml 编译错误，错误信息："+a.compile_err_msg),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_COMPILE_WXSS_FAIL)return m("wxss 编译错误，错误信息："+a.compile_err_msg),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_COMPILE_INVALID_JSON_FILE)return m("json 编译错误，错误信息："+a.compile_err_msg),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_COMPILE_LACK_OF_FILE)return m("缺少文件，错误信息："+a.compile_err_msg),i.error("details.js uploadForTest error "+h),void this.setState(l);if(h===c.DEV_Need_Update)return m("工具版本过旧，请升级工具后重试"),i.error("details.js uploadForTest error "+h),void this.setState(l);var E=e();u&&(E=E+", 编译包大小 "+u+" kb"),0===h?(l.qrcode_img=a.qrcode_img,"test"===r?(l.lastTestTime=E,localStorage.setItem("last-up-test-time-"+this.props.project.hash,E)):(l.lastUploadTime=E,localStorage.setItem("last-up-load-time-"+this.props.project.hash,E)),l.showDailog=!1,this.setState(l)):(m("系统错误，错误代码："+h+",错误信息："+d.errmsg),this.setState(l))}},onEs6Change:function(){var e=!this.state.es6;p.setProjectEs6(this.props.project.hash,e),this.setState({es6:e})},onMinified:function(){var e=!this.state.minified;p.setProjectMinified(this.props.project.hash,e),this.setState({minified:e})},onAutoWatcher:function(){var e=!this.state.watcher;p.setProjectWatcher(this.props.project.hash,e),this.setState({watcher:e})},render:function(){var e=this.props,a=e.show,r=e.project,i=this.state.isTourist,o="detail"===a?{}:s.displayNone,c=r.app_head_img||"../images/logo.png",n=r?decodeURIComponent(r.appname):"",p=r?r.appid:"",m=r?r.projectpath:"",h="",u=s.displayNone,E="";if(this.state.qrcode_img){h=t.createElement("img",{src:"data:image/png;base64,"+this.state.qrcode_img,style:{width:"200px",heigth:"200px",marginBottom:"20px"}}),u={};var g=+new Date+15e5,_=new Date(g),j=l.getUserInfo();E="请使用 "+j.nickName+" 的微信扫描二维码，预览当前开发版本，二维码将在 "+_.toTimeString().replace(/\s.*/g,"")+" 时失效。"}var f=this.state.es6,v=this.state.minified,S=this.state.watcher;return t.createElement("div",{className:"detail",style:o},t.createElement("div",{className:"detail-logo-wrapper"},t.createElement("img",{src:c,className:"detail-logo"}),t.createElement("p",{className:"detail-name"},n),t.createElement("p",{className:"detail-appid"},"App ID: ",p)),t.createElement("div",{className:"detail-meta-wrapper"},t.createElement("div",{className:"detail-meta"},t.createElement("p",{className:"detail-meta-label"},"本地开发目录"),t.createElement("p",{className:"detail-meta-value"},m)),t.createElement("div",{className:"detail-meta "+(i?"detail-meta-disabled":"")},t.createElement("p",{className:"detail-meta-label"},"最近上传时间"),t.createElement("p",{className:"detail-meta-value"},this.state.lastUploadTime),t.createElement("a",{onClick:this.upload,href:"javascript:;",className:"detail-meta-upload-default "+(i?"detail-meta-upload-default-disabled":"")},"上传")),t.createElement("div",{className:"detail-meta "+(i?"detail-meta-disabled":"")},t.createElement("p",{className:"detail-meta-label"},"最新更新时间"),t.createElement("p",{className:"detail-meta-value"},this.state.lastTestTime),t.createElement("a",{onClick:this.uploadForTest,href:"javascript:;",className:this.state.testBtnClass+"  "+(i?"detail-meta-upload-disabled":"")},this.state.testBtnTitle)),t.createElement("div",{className:"detail-meta detail-meta-column"},t.createElement("label",{htmlFor:"es6toes5",onClick:this.onEs6Change,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:f}),t.createElement("i",null),"开启 ES6 转 ES5"),t.createElement("label",{htmlFor:"watcher",onClick:this.onAutoWatcher,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:S}),t.createElement("i",null),"监听文件变化，自动刷新开发者工具"),t.createElement("label",{htmlFor:"minified",onClick:this.onMinified,className:"detail-meta-es6toes5"},t.createElement("input",{type:"checkbox",checked:v}),t.createElement("i",null),"开启 代码压缩上传"))),t.createElement("div",{className:"detail-opr-wrapper"},t.createElement("a",{onClick:this.delProject,href:"javascript:;",className:"button"},"删除项目")),t.createElement(d,{ref:"uploadWnd",getResp:this.getResp,isTourist:i,project:this.props.project}),t.createElement("div",{className:"setting-show",style:u},t.createElement("div",{className:"setting-hd"},t.createElement("h3",{className:"setting-hd-title"},"预览")),t.createElement("div",{className:"setting-bd"},h,t.createElement("p",null,E)),t.createElement("div",{className:"setting-ft"},t.createElement("a",{href:"javascript:;",onClick:this.closeImg,className:"setting-button-default"},"确定"))))}});_exports=u}var _exports;init(),module.exports=_exports;