"use strict";function init(){var e=require("../../lib/react.js"),a=require("../../cssStr/cssStr.js"),t=require("../../stores/webviewStores.js"),r=require("../../actions/webviewActions.js"),c=(require("../../actions/leftviewActions.js"),require("../../stores/leftviewStores.js"),require("../../common/log/log.js")),i=require("../../common/jssdk/sdkNameTrans.js"),d=require("../../config/errcodeConfig.js"),s="https://mp.weixin.qq.com/debug/cgi-bin/webdebugger/acceptcarditem",m=e.createClass({displayName:"WebviewCard",getInitialState:function(){return{showDetails:!1}},cancel:function(){this.close();var e=this.props.cardInfo,a=e.data,t=e.webviewID,c=e.sdkName,d=e.isHavePurview;if("batchViewCard"!==c){var s={errMsg:i.getSdkDisplayName(c)+":cancel"},m={type:"CARD_SDK"};r.sendJSSDKRes(t,c,s,a.ext),r.setSdkLog(t,a,d,s,m)}},close:function(e){return this.state.showDetails?void this.setState({showDetails:!1}):void this.props.closeCard()},batchAddCard:function(e){for(var a=this,t=e.currentTarget,i=t.dataset,d=i.index,m=this.props.cardInfo,o=m.data,n=o.args,l=m.webviewID,v=m.sdkName,w=m.isHavePurview,b=n.appId,_=this.props.cardInfo.cardData[d],h=n.card_list[d],N=[],E=0;E<_.amount;E++)N.push({card_id:h.card_id,card_ext:h.card_ext,is_succ:1});var u=require("../../common/request/request.js"),p={appid:b,acceptitem_list:N,js_checinfo_url:o.ext.url},g={url:s,body:JSON.stringify(p),method:"post",needToken:!0},f={type:"CARD_SDK"};c.info("WebviewCards.js batchAddCard request begin "+JSON.stringify(g)),u(g,function(e,t,i){if(e){c.info("WebviewCards.js batchAddCard request error "+JSON.stringify(e));var d={errMsg:"addCard:fail; "+JSON.stringify(e)};r.sendJSSDKRes(l,v,d,o.ext),r.setSdkLog(l,o,w,d,f),a.close()}else{c.info("WebviewCards.js batchAddCard request end "+i);var s=JSON.parse(i),m=s.baseresponse;if(0===m.errcode){var n={errMsg:"addCard:ok",card_list:JSON.stringify(N)},b=N.map(function(e){return{cardExt:e.card_ext,cardId:e.card_id,isSuccess:!0}}),_={errMsg:"addCard:ok",cardList:b};r.sendJSSDKRes(l,v,n,o.ext),r.setSdkLog(l,o,w,_,f),a.close()}else{var h={errMsg:"addCard:fail; "+m.errmsg};r.sendJSSDKRes(l,v,h,o.ext),r.setSdkLog(l,o,w,h,f),a.close()}}})},chooseCard:function(e){var a=this.props.cardInfo,t=a.data,c=a.sdkName,i=a.webviewID,d=a.isHavePurview,s=e.currentTarget,m=s.dataset,o={type:"CARD_SDK"},n=[{card_id:m.cardid,encrypt_code:m.encryptcode}],l={errMsg:"chooseCard:ok",choose_card_info:JSON.stringify(n)};r.sendJSSDKRes(i,c,l,t.ext),r.setSdkLog(i,t,d,l,o),this.close()},formatTime:function(e){var a=new Date(1e3*e);return a.getFullYear()+"."+(a.getMonth()+1)+"."+a.getDate()},cardDetail:function(e){var a=e.currentTarget,t=a.dataset,r=t.index;this.setState({showDetails:!0,cardIndex:r})},render:function(){var r=this,c=this.props.showCard?{}:a.displayNone,i=t.getOffset();delete i.dpr,c=Object.assign({},c,i);var s=this.props.cardInfo,m=s.sdkName,o=s.cardData,n=e.createElement("div",null);if("batchAddCard"===m)!function(){var a={},t=o.map(function(t,c){if(t.errmsg)return e.createElement("div",{className:"webview-card-add-item",key:c},e.createElement("div",{className:"webview-card-add-item_top"},e.createElement("div",{className:"webview-card-add-item_details"},e.createElement("div",{className:"webview-card-add-item_name"},"cardId: ",t.card_id),e.createElement("div",{className:"webview-card-add-item_info"},e.createElement("span",{className:"webview-card-add-item_intro"},"errmsg: ",t.errmsg)))),e.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_error"},e.createElement("div",{className:"webview-card-add-item_button"},"错误卡券")));var i=t.card_tp_info,d=i.brand_name,s=i.title,m=i.logo_url,o=t.card_data_info;a.backgroundColor=i.color;var n=r.formatTime(i.begin_time),l=r.formatTime(i.end_time),v=0===o.limit_num,w=void 0;return w=v?e.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_disable",style:a},e.createElement("div",{className:"webview-card-add-item_button_error"},i.limit_wording)):e.createElement("div",{"data-index":c,onClick:r.batchAddCard,className:"webview-card-add-item_bottom",style:a},e.createElement("div",{className:"webview-card-add-item_button"},i.accept_wording)),e.createElement("div",{className:"webview-card-add-item",key:c},e.createElement("div",{className:"webview-card-add-item_top"},e.createElement("div",{className:"webview-card-add-item_left"},e.createElement("img",{className:"webview-card-add-item_img",src:m})),e.createElement("div",{className:"webview-card-add-item_details"},e.createElement("div",{className:"webview-card-add-item_name"},d),e.createElement("div",{className:"webview-card-add-item_info"},e.createElement("span",{className:"webview-card-add-item_intro"},s),e.createElement("span",{className:"webview-card-add-item_num"},"X",t.amount)),e.createElement("div",{className:"webview-card-add-item_time"},n," - ",l))),w)});n=e.createElement("div",{className:"webview-card-add",style:a},e.createElement("div",{className:"webview-card-add-header"},e.createElement("div",{className:"webview-card-add-header_button",onClick:r.cancel}," 取消 "),e.createElement("div",{className:"webview-card-add-header_title"}," 添加卡卷 ")),e.createElement("div",{className:"webview-card-add-container"},t))}();else if("chooseCard"===m){var l=o.available_cards,v=l.map(function(a,t){return e.createElement("div",{onClick:r.chooseCard,key:t,"data-appid":a.app_id,"data-cardid":a.card_tp_id,"data-encryptcode":a.encrypt_code,className:"webview-card-choose-item"},e.createElement("div",{className:"webview-card-choose_m"},e.createElement("div",{className:"webview-card-choose_left"},e.createElement("img",{className:"webview-card-choose-item_img",src:a.logo_url})),e.createElement("div",{className:"webview-card-choose_details"},e.createElement("div",{className:"webview-card-choose-item_name"},a.sub_title),e.createElement("div",{className:"webview-card-choose-item_info"},a.title))))}),w=void 0;w=v.length?e.createElement("div",{className:"webview-card-choose-container",style:{height:i.height-42}},e.createElement("span",{className:"webview-card-choose-mycard"},"我的卡卷"),e.createElement("div",{className:"webview-card-choose-item"},v)):e.createElement("div",{className:"webview-card-choose-container",style:{height:i.height-42}},e.createElement("span",{className:"webview-card-choose-mycard webview-card-choose-mycardEmpty"},"暂无可添加的卡券")),n=e.createElement("div",{className:"webview-card-choose"},e.createElement("div",{className:"webview-card-choose-header"},e.createElement("div",{className:"webview-card-choose-header_button",onClick:this.cancel}," 取消 "),e.createElement("div",{className:"webview-card-choose-header_title"}," 选择卡卷 ")),w)}else if("batchViewCard"===m){var b=s.cardData.retData.card_array,_=s.cardData.errData,h=!!_.length,N=this.state.showDetails;if(1===b.length&&!h||N){var E=N?b[this.state.cardIndex]:b[0],u=E.card_data_info,p=this.formatTime(u.begin_time),g=this.formatTime(u.end_time),f=E.card_tp_info,C=f.brand_name,y=f.title,S=f.logo_url,D=0===f.limit_num,k=void 0,x={};x.backgroundColor=f.color,k=D?e.createElement("div",{className:"webview-card-add-item_bottom webview-card-add-item_bottom_disable"},e.createElement("div",{className:"webview-card-add-item_button_error"},f.limit_wording)):e.createElement("div",{onClick:this.batchAddCard,className:"webview-card-add-item_bottom"},e.createElement("div",{className:"webview-card-add-item_button"},f.accept_wording));var I=N?"返回":"关闭";n=e.createElement("div",{className:"webview-card-open",style:x},e.createElement("div",{className:"webview-card-open-header"},e.createElement("div",{className:"webview-card-open-header_button",onClick:this.cancel}," ",I," ")),e.createElement("div",{className:"webview-card-open-container"},e.createElement("div",{className:"webview-card-open_top"},e.createElement("img",{className:"webview-card-open-item_img",src:S})),e.createElement("div",{className:"webview-card-open_middle"},e.createElement("div",{className:"webview-card-open-name"},C),e.createElement("div",{className:"webview-card-open-intro"},y),e.createElement("div",{className:"webview-card-open-item_button",style:x},e.createElement("div",{className:"webview-card-open_buttom_wording"},"立即使用")),e.createElement("div",{className:"webview-card-open-time"},"有效期: ",p,"-",g)),e.createElement("div",{className:"webview-card-open_bottom"},e.createElement("div",{className:"webview-card-open_detail"},"兑换卷详情"),e.createElement("div",{className:"webview-card-open_detail"},"公众号"),e.createElement("div",{className:"webview-card-open_detail"},"在线兑换"))))}else{var q=b.map(function(a,t){var c=a.card_tp_info;return e.createElement("div",{onClick:r.cardDetail,key:t,"data-index":t,className:"webview-card-choose-item"},e.createElement("div",{className:"webview-card-choose_m"},e.createElement("div",{className:"webview-card-choose_left"},e.createElement("img",{className:"webview-card-choose-item_img",src:c.logo_url})),e.createElement("div",{className:"webview-card-choose_details"},e.createElement("div",{className:"webview-card-choose-item_name"},c.brand_name),e.createElement("div",{className:"webview-card-choose-item_info"},c.title))))}),j=_.map(function(a,t){var r="INVALID_CODE"===d[a.errcode]?"错误卡券 ID":"错误卡卷 code";return e.createElement("div",{key:t,className:"webview-card-choose-item"},e.createElement("div",{className:"webview-card-choose_mErr"},e.createElement("div",{className:"webview-card-choose_details"},e.createElement("div",{className:"webview-card-choose-item_error"},r),e.createElement("div",{className:"webview-card-choose-item_error"},"cardId: ",a.card_id),e.createElement("div",{className:"webview-card-choose-item_error"},"code: ",a.code))))});n=e.createElement("div",{className:"webview-card-choose"},e.createElement("div",{className:"webview-card-choose-header"},e.createElement("div",{className:"webview-card-choose-header_button",onClick:this.cancel}," 关闭 "),e.createElement("div",{className:"webview-card-choose-header_title"}," 卡券列表 ")),e.createElement("div",{className:"webview-card-choose-container",style:{height:i.height-42}},e.createElement("div",{className:"webview-card-choose-item"},q,j)))}}return e.createElement("div",{className:"webview-card",style:c},n)}});_exports=m}var _exports;init(),module.exports=_exports;