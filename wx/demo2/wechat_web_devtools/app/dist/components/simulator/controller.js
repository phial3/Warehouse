"use strict";function init(){var e=require("../../lib/react.js"),t=require("../../lib/react-dom.js"),r=require("./toolbar/toolbar.js"),i=require("./toolbar/scanDialog.js"),s=require("./webviewtab.js"),o=require("./webview.js"),a=require("../../weapp/utils/tools.js"),n=require("../../stores/webviewStores.js"),c=(require("../../stores/windowStores.js"),require("../../actions/windowActions.js")),p=require("../../actions/webviewActions.js"),u=(require("../../stores/projectStores.js"),require("../../cssStr/cssStr.js")),l=(require("../../common/log/log.js"),require("../../common/request/request.js")),v=require("./actions/simulatorActions.js"),f=require("./webviewBackwardMask.js"),h=(require("../../utils/tools.js"),require("url")),d=require("../../config/urlConfig.js"),g=require("../../weapp/utils/projectManager.js"),w=require("./webview/modal.js"),b=require("./webview/toast.js"),S=require("./webview/picker"),m=require("./webview/actionSheet.js"),_=require("./webview/previewImage.js"),I=require("../../config/weappConfig.js"),W=I.default_tabheight,E=I.default_backgroundColor,y=0,D=0,N=e.createClass({displayName:"Controller",getInitialState:function(){var e="app/html/about.html",t=0,r=0,i={},s={window:{}},o={},a={},c=n.getOffset(),p=!1,u=!1,l="",v=this.props.project;if(v){try{e=g.getAppEntranceSync(v),s=g.getAppJSONSync(v),i=s.tabBar||{};var f=s.pages||[];a=g.getPageJSONSync(v,f[0])}catch(h){e=""}var d=this.getTabPageIndex(e,i);p=d>-1&&i.list[d].pagePath}return{currentWebviewID:t,showCard:u,tabBar:i,appJSON:s,offset:c,cardInfo:o,list:{0:{href:e,dataURI:l,preWebviewID:r,pageJSON:a,isTabbar:p}}}},setAnimateImg:function(e,r){var i=document.createElement("div");if(r.dataURI){var s=document.createElement("img");i.appendChild(s),s.src=r.dataURI}i.className="simulator-animate-png";var o=t.findDOMNode(this.refs["webview"+this.state.currentWebviewID]),a=o.getBoundingClientRect(),n=a.top,c=a.left,p=a.height,u=a.width;e?i.style.cssText="background-color:"+r.color+";width:"+u+"px;height:"+p+"px;top:"+n+"px;left:"+c+"px;transform:translate3d("+u+"px,0,0)":i.style.cssText="margin-top:42px;width:"+u+"px;height:"+(p-42)+"px;top:"+n+"px;left:"+c+"px;transform:translate3d(0,0,0)",global.contentDocumentBody.appendChild(i);i.offsetTop;return i},postAppRoute:function(e,t,r){if(this.props.project){e=e.replace(/http\:\/\/.*?\//,"");var i=e.match(/(([^\?]*)(\?([^\/]*))?)$/),s="",o={};if(i){s=i[2]||"index.wxml";for(var a=(i[4]||"").split("&"),n=0;n<a.length;++n){var c=a[n].split("=");2==c.length&&(o[c[0]]=c[1])}}this.getSimulatorActions("S_POSTMSG_TO_AS",null,{eventName:"onAppRoute",type:"ON_APPLIFECYCLE_EVENT",data:{path:s,query:o,openType:r},webviewID:t})}},goBack:function(e,r,i,s){var o=this;if(s=s||1,this.props.project||!r.canGoBack()||i){var n,c,p,u=function(){if(0===e)return{v:void 0};for(c=e,p=[];s--&&o.state.list[c]&&0!=c;)p.push(c),n=o.state.list[c],c=n.prevWebviewID;o.state.list[c]||(c=0);var i=t.findDOMNode(o.refs["webview"+e]),u=i.querySelector(".webviewbody"+e);u.captureVisibleRegion(function(e){var i=o.setAnimateImg(!1,{dataURI:e}),s=u.offsetWidth,n=Object.assign({},o.state.list);for(var l in p)delete n[p[l]];o.setState({list:n,currentWebviewID:c},function(){i.addEventListener("transitionend",function(){global.contentDocumentBody.removeChild(i);var e=t.findDOMNode(o.refs["webview"+c]),s=e.querySelector(".webviewbody"+c);if(o.props.project){var n=r.src,u=a.getBaseURL(o.props.project);0===n.indexOf(u)&&o.postAppRoute(s.src,o.state.currentWebviewID,"navigateBack")}for(var l in p)o.getSimulatorActions("S_DELETE_WEBVIEW",null,{webviewID:p[l]});o.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:c})}),i.style.transform="translate3d("+s+"px,0,0)"})})}();if("object"===("undefined"==typeof u?"undefined":_typeof(u)))return u.v}else r.back()},_getOpenWebviewNum:function(){var e=this.state.list,t=1;for(var r in e)e.hasOwnProperty(r)&&e[r]&&!e[r].isTabbar&&t++;return t},_openNewWebview:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},i=e.webviewID,s=e.url,o=e.isMap;if(!e.isMap&&this._getOpenWebviewNum()>5)return void r(-1);var a=this.state.appJSON,n={},c=E;if(!o){try{n=g.getPageJSONSync(this.props.project,s)}catch(p){}c=n.backgroundColor||a.window.backgroundColor||E}var u=this.setAnimateImg(!0,{color:c});u.style.transform="translate3d(0,0,0)",r(null),u.addEventListener("transitionend",function(){u.parentNode.removeChild(u),y++;var e=Object.assign({},t.state.list);e[y]={prevWebviewID:i,href:s,pageJSON:n,isMap:o},t.setState({currentWebviewID:y,list:e}),t.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:y})})},_openNewWindowWebview:function(e){var t=this,r=e.url,i={},s=this.props.project;try{i=g.getPageJSONSync(s,r)}catch(o){}var n=(i.backgroundColor||"#ffffff",a.getBaseURL(s));r=h.resolve(n,r+".html");var c=this.state.list,p={};for(var u in c)if(c[u].isTabbar===e.url){p.currentWebviewID=u;break}if(void 0===p.currentWebviewID){p.currentWebviewID=++y;var l=Object.assign({},this.state.list);l[y]={showUrl:!1,hideBack:!0,isTabbar:e.url,href:r,pageJSON:i},p.list=l}var v=p.currentWebviewID;return this.setState(p,function(){t.postAppRoute(r,v,"switchTab"),t.getSimulatorActions("S_CHANGE_CURRENT_WEBVIEW",null,{webviewID:v})}),v},_changeWebviewID:function(e){this.setState({currentWebviewID:e})},_setWebviewInfo:function(e){var t=0,r=this.state.tabBar,i=r.list||[];t=i.length<=5&&i.length>=3?W:0,e.height&&this.setState({offset:{height:e.height-t,width:e.width,dpr:e.dpr}})},_setWebviewSnapshot:function(e,t){var r=Object.assign({},this.state.list);r[e].dataURI=t,this.setState({list:r})},_postMessageToAllWebview:function(e){var t=this,r=e.webviewIds||[],i=0===r.length;setTimeout(function(){e.act="sendMsgFromAppService";var s=void 0;s=i?Object.keys(t.state.list):r,s.forEach(function(r){t.getSimulatorActions("S_SET_ACTION",r,e)})},17)},_getShortUrl:function(e){var t="";if(this.props.project){var r=this.props.project;t=a.getBaseURL(r)}return e.replace(t,"")},_asSdk:function(e,r,i){var s=this;if("redirectTo"===e){var o=this.state.currentWebviewID,a=t.findDOMNode(this.refs["webview"+o]),c=a.querySelector(".webviewbody"+o);c.src=r.args.url;var u={};try{u=g.getPageJSONSync(this.props.project,r.args.url)}catch(v){}var f=Object.assign({},this.state.list);f[o].pageJSON=u,this.setState({list:f}),i({errMsg:"redirectTo:ok",url:this._getShortUrl(r.args.url),webviewId:o})}else if("navigateTo"===e){var h=this.state.currentWebviewID;this._openNewWebview({webviewID:h,url:r.args.url},function(e){i(null!==e?{errMsg:"navigateTo:fail webview count limit exceed."}:{errMsg:"navigateTo:ok",url:s._getShortUrl(r.args.url),webviewId:y+1})})}else if("navigateBack"===e)!function(){var e=s.state.currentWebviewID,o=t.findDOMNode(s.refs["webview"+e]),a=o.querySelector(".webviewbody"+e);s.goBack(s.state.currentWebviewID,a,!1,r.args.delta||1),setTimeout(function(){i({errMsg:"navigateBack:ok",url:s._getShortUrl(a.src)})},200)}();else if("setNavigationBarTitle"===e)setTimeout(function(){var t=s.state.currentWebviewID,o=r.args;s.getSimulatorActions("S_SET_WEBVIEW_MARGIN",t,{name:e,value:o.title||""}),i({errMsg:"setNavigationBarTitle:ok"})},400);else if("showNavigationBarLoading"===e)!function(){var t=s.state.currentWebviewID;r.args;setTimeout(function(){s.getSimulatorActions("S_SET_WEBVIEW_MARGIN",t,{name:e}),i({errMsg:e+":ok"})},0)}();else if("hideNavigationBarLoading"===e)!function(){var t=s.state.currentWebviewID;r.args;setTimeout(function(){s.getSimulatorActions("S_SET_WEBVIEW_MARGIN",t,{name:e}),i({errMsg:e+":ok"})},0)}();else if("chooseLocation"===e)!function(){var e=s.state.currentWebviewID,t=r.url;s._openNewWebview({isMap:!0,webviewID:e,url:t});var o={};s.chooseLocation=function(e){return e?void(o=e):void i(0===Object.keys(o).length?{errMsg:"chooseLocation:fail"}:{name:o.poiname,address:o.poiaddress,latitude:o.latlng.lat,longitude:o.latlng.lng,errMsg:"chooseLocation:ok"})},s.closeLocation=function(){i({errMsg:"chooseLocation:cancel"})}}();else if("openLocation"===e){var w=this.state.currentWebviewID;this._openNewWebview({isMap:!0,webviewID:w,url:r.url}),i({errMsg:"openLocation:ok"})}else if("scanCode"===e)!function(){var e=function s(e){i("ok"==e.msg?{errMsg:"scanCode:ok",result:e.result,scanType:e.scanType}:"cancel"==e.msg?{errMsg:"scanCode:cancel"}:{errMsg:"scanCode:"+e.msg}),n.removeListener("SCAN_CODE_RETURN",s)},t=r.args;setTimeout(function(){p.showScanCodeDialog(t),n.on("SCAN_CODE_RETURN",e)},0)}();else if("operateWXData"===e)!function(){var e="",t=r.args;if(s.props.project){var o=s.props.project;e=o.appid}l({url:d.jsOperateWXDATAURL+"?appid="+e,method:"post",body:JSON.stringify({data:JSON.stringify(t.data||{})}),needToken:1},function(r,o,a){var c={},p="";if(!r&&200===o.statusCode&&(a=JSON.parse(a),a.baseresponse))if(0==a.baseresponse.errcode)try{c.data=JSON.parse(a.data),c.errMsg="operateWXData:ok"}catch(u){c.errMsg="operateWXData:fail"}else if(a.baseresponse.errcode==-12e3){var v,f=function(){v=D++;var r=function o(r,s,a){c.errMsg=a?"operateWXData:ok":"operateWXData:cancel";var p=s[0];if(a&&p.checked){var u={data:JSON.stringify(t.data||{}),grant_scope:p.scope};l({url:d.jsOperateWXDATAURL+"?appid="+e,method:"post",body:JSON.stringify(u),needToken:1},function(e,t,r){var s={};if(!e&&200===t.statusCode&&(r=JSON.parse(r),r.baseresponse&&0===r.baseresponse.errcode))try{s.data=JSON.parse(r.data),s.errMsg="operateWXData:ok"}catch(o){s.errMsg="operateWXData:fail"}s.errMsg||(s.errMsg="operateWXData:fail; "),i(s)})}else i(c);n.removeListener("AUTHORIZE_SDK_RETURN_"+r,o)};return n.on("AUTHORIZE_SDK_RETURN_"+v,r),s.getSimulatorActions("S_AUTHORIZE_SDK",s.state.currentWebviewID,{authorizeSdkId:v,url:a.appicon_url+"/0",appname:a.appname,scope_list:[a.scope]}),{v:void 0}}();if("object"===("undefined"==typeof f?"undefined":_typeof(f)))return f.v}else p=a.baseresponse.errmsg;c.errMsg||(c.errMsg="operateWXData:fail; "+p),i(c)})}();else if("authorize"===e)!function(){var e="";if(s.props.project){var t=s.props.project;e=t.appid}var o=r.args,a={scope:o.scope||[]};l({url:d.jsAuthorizeURL+"?appid="+e,method:"post",body:JSON.stringify(a),needToken:1},function(t,r,o){var a={},c="";if(!t&&200===r.statusCode&&(o=JSON.parse(o),o.baseresponse))if(a.body=o,0==o.baseresponse.errcode)a.errMsg="authorize:ok";else if(o.baseresponse.errcode==-12e3){var p,u=function(){p=D++;var t=function r(t,s,o){if(a.errMsg=o?"authorize:ok":"authorize:cancel",o){for(var c=[],p=0;p<s.length;++p){var u=s[p];u.checked&&c.push(u.scope)}console.log(s);var v={scope:c};l({url:d.jsAuthorizeConfirmURL+"?appid="+e,method:"post",body:JSON.stringify(v),needToken:1},function(e,t,r){var s={};e||200!==t.statusCode||(r=JSON.parse(r),r.baseresponse&&0===r.baseresponse.errcode&&(s.errMsg="authorize:ok")),s.errMsg||(s.errMsg="authorize:fail; "),i(s)})}else i(a);n.removeListener("AUTHORIZE_SDK_RETURN_"+t,r)};return n.on("AUTHORIZE_SDK_RETURN_"+p,t),s.getSimulatorActions("S_AUTHORIZE_SDK",s.state.currentWebviewID,{authorizeSdkId:p,url:o.appicon_url+"/0",appname:o.appname,scope_list:o.scope_list}),{v:void 0}}();if("object"===("undefined"==typeof u?"undefined":_typeof(u)))return u.v}else c=o.baseresponse.errmsg;a.errMsg||(a.errMsg="authorize:fail; "+c),i(a)})}();else if("getSystemInfo"===e||"getSystemInfoSync"===e){var b=this.state.currentWebviewID,S=n.getInfo(),m=this.state.list[b];i({errMsg:e+":ok",model:S.model,pixelRatio:S.dpr,windowWidth:S.width,windowHeight:this.getTabPageIndex(m.href)>-1?S.height-W:S.height,language:"zh_CN",version:"6.3.9"})}},_upWebviewStatus:function(e,t){this.upCurrentWebviewURL(t.url)},getTabPageIndex:function(e,t){var r=a.getFileNameFromUrl(e,this.props.project).replace(/\.wxml$/,"");t=t||this.state.tabBar;var i=t.list||[],s=i.findIndex(function(e){return e.pagePath===r});return s},upCurrentWebviewURL:function(e){},getSimulatorActions:function(e,r,i){var s={currentWebviewID:this.state.currentWebviewID};if(v(e,r,i,s),"S_CHANGE_CURRENT_WEBVIEW"===e){var o=i.webviewID;if(o===this.state.currentWebviewID){var a=t.findDOMNode(this.refs["webview"+o]),n=a.querySelector("webview"),p=n.src;this.upCurrentWebviewURL(p),c.changeUrl(p,o)}}},projectHasTab:function(){var e=this.state.tabBar.list||[],t=e.length;return t&&e.length<=5&&e.length>=2},componentDidMount:function(){n.on("CHANGE_WEBVIEW_ID",this._changeWebviewID),n.on("SET_WEBVIEW_INFO",this._setWebviewInfo),n.on("AS_PUBLISH",this._postMessageToAllWebview),n.on("SEND_AS_SDK",this._asSdk),n.on("SET_WEBVIEW_SNAPSHOT",this._setWebviewSnapshot),n.on("UP_WEBVIEW_STATUS",this._upWebviewStatus);var e=this.props.project?1:12;chrome.fontSettings.setMinimumFontSize({pixelSize:e})},componentWillUnmount:function(){n.removeListener("CHANGE_WEBVIEW_ID",this._changeWebviewID),n.removeListener("SET_WEBVIEW_INFO",this._setWebviewInfo),n.removeListener("AS_PUBLISH",this._postMessageToAllWebview),n.removeListener("SEND_AS_SDK",this._asSdk),n.removeListener("SET_WEBVIEW_SNAPSHOT",this._setWebviewSnapshot),n.removeListener("UP_WEBVIEW_STATUS",this._upWebviewStatus)},chooseLocation:function(){},closeLocation:function(){},render:function(){var t=[];for(var a in this.state.list){var n=a==this.state.currentWebviewID?{}:u.webviewDisplayNone,c=this.state.list[a],p=this.getTabPageIndex(c.href),l=null,v=null,h=Object.assign({},this.state.offset);if(this.projectHasTab()&&p>-1){var d=this.state.tabBar.position,g={width:this.state.offset.width,margin:"0 auto"},I=e.createElement("div",{style:g},e.createElement(s,{webviewID:a,tabPageIndex:p,project:this.props.project,_openNewWindowWebview:this._openNewWindowWebview,tabBar:this.state.tabBar}));"top"===d?l=I:v=I,h.height=h.height-W}t.push(e.createElement("div",{key:a,style:n},e.createElement("div",{className:"simulator-shadow",style:{width:h.width}},l,e.createElement(o,{ref:"webview"+a,webviewID:a,project:this.props.project,offset:h,isTabWebview:p>-1,href:c.href,pageJSON:c.pageJSON,appJSON:this.state.appJSON,isMap:c.isMap,chooseLocation:this.chooseLocation,closeLocation:this.closeLocation,hideBack:!!c.hideBack,goBack:this.goBack,getSimulatorActions:this.getSimulatorActions,postAppRoute:this.postAppRoute}),v)))}return e.createElement("div",{className:"simulator-wrapper"},e.createElement(r,{getSimulatorActions:this.getSimulatorActions,list:this.state.list,currentWebviewID:this.state.currentWebviewID,project:this.props.project,show:this.props.show}),e.createElement(i,{currentWebviewID:this.state.currentWebviewID}),e.createElement("div",{className:"simulator-list-wrapper",style:{width:this.state.offset.width}},t,e.createElement(m,null),e.createElement(b,{project:this.props.project}),e.createElement(w,null),e.createElement(S,{webviewID:this.state.currentWebviewID}),e.createElement(_,{width:this.state.offset.width,project:this.props.project})),e.createElement(f,null))}});_exports=N}var _typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(e){return"undefined"==typeof e?"undefined":_typeof2(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":"undefined"==typeof e?"undefined":_typeof2(e)},_exports;init(),module.exports=_exports;
