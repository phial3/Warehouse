"use strict";function init(){function e(){R.info("projectManager.js cleanProjects");for(var e in F)F[e].watcher.close();F={}}function r(n){var i=n.hash;if(!F[i]){Object.keys(F).length>y&&e(),R.info("manager.js initProject projectid "+n.projectid);var a={};a.watcher=v.watch(n.projectpath,{ignored:[/node_modules/],ignoreInitial:!0,ignorePermissionErrors:!0,followSymlinks:!0,interval:1e3,binaryInterval:1e3}).on("all",function(e,r,i){r=f.relative(n.projectpath,r),t(n,e,r,i)}),a.watcher.on("error",function(t){t&&!O&&(R.error("projectManager.js obj.watcher error "+t.toString()),O=!0,e(),r(n))}),a.cache={},a.wxmlFileList=[],a.jsFileList=[],F[i]=a}}function t(e,r,t,a){var o=e.hash,c=F[o].cache;t=t.replace(/\\/g,"/"),"app.json"===t&&(F[o].cache={}),t&&c[t]&&delete c[t];var s=f.extname(t);".wxml"===s?n(e):".js"===s&&i(e),x.fileChange(e,r,t,a)}function n(e,r){g("./**/*.wxml",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"]},function(t,n){if(t)r&&r(t,[]);else{var i=e.hash;F[i].wxmlFileList=n,r&&r(null,n)}})}function i(e,r){g("**/*.js",{nodir:!0,cwd:e.projectpath,ignore:["node_modules/**/*"]},function(t,n){if(t)r&&r(t,[]);else{var i=e.hash;F[i].jsFileList=n,r&&r(null,n)}})}function a(e,t){var n=e.project,i=n.hash;r(n);var a=decodeURIComponent(e.fileName),o=F[i].cache;if(o[a])return void process.nextTick(function(){t(o[a].error,o[a].data)});var c=n.es6,s=e.needRequire,l=f.join(n.projectpath,a);h.readFile(l,"utf8",function(e,r){if(e)return void t({e:e,type:E.PAGEJS_FILE_ERROR,file:a});if(c){var n=f.basename(a);try{var i=m.transform(r,{presets:["es2015"],sourceMaps:"inline",sourceFileName:n,babelrc:!1});r=i.code.replace("sourceMappingURL=data:application/json;","sourceMappingURL=data:application/json;charset=utf-8;")}catch(e){return void t({e:e,sourceFileName:n},r)}}r='define("'+a+'", function(require, module, exports, '+_+"){ "+r+"\n});",s&&(r+='require("'+a+'")'),o[a]={error:null,data:r},t(null,r)})}function o(e,t,n){r(e);var i=e.hash,a=F[i].cache;if(a[t])return void process.nextTick(function(){n(a[t].error,a[t].data)});R.info("manager.js project "+i+" getFile "+t);var o=f.join(e.projectpath,t);h.readFile(o,function(e,r){e||(a[t]={error:e,data:r}),n(e,r)})}function c(e,t){r(e);var i=e.hash,a=F[i].wxmlFileList;a.length?process.nextTick(function(){t(null,a)}):n(e,t)}function s(e,t){r(e);var n=e.hash,a=F[n].jsFileList;a.length?process.nextTick(function(){t(null,a)}):i(e,t)}function l(e,t){r(e);var n=e.hash,i=j.parse(t),a=i.pathname.replace(/^\//,""),o=f.extname(a),c=o?a.replace(o,".json"):a+".json",s=F[n].cache;if(s[c])return s[c];var l=e.projectpath,u=p(e),d=f.join(l,c),g=h.existsSync(d),v={};if(g){var m=h.readFileSync(d,"utf8");try{v=JSON.parse(m)}catch(R){throw{e:R,data:m,type:E.JSON_PARSE_ERROR,file:c}}}return s[c]=Object.assign({},u.window,v),s[c]}function p(e){r(e);var t=e.hash,n="app.json",i=F[t].cache,a=i[n];if(a)return a;var o=e.projectpath,c=f.join(o,"app.json"),s=void 0;try{s=h.readFileSync(c,"utf8")}catch(l){throw{e:l,type:E.JSON_FILE_ERROR,file:"app.json"}}try{a=JSON.parse(s)}catch(l){throw{e:l,type:E.JSON_PARSE_ERROR,file:"app.json",data:s}}var p=a.pages;if(!p||0===p.length)throw{type:E.JSON_ENTRANCE_ERROR,file:"app.json",data:s};return a.window||(a.window={}),i[n]=a,a}function u(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=S.getBaseURL(e);if(r.justHost)return t;var n=p(e)||{},i=n.pages||[];return j.resolve(t,i[0]+".html")}var h=require("fs"),f=require("path"),j=require("url"),d=require("events").EventEmitter,g=require("glob"),v=require("chokidar"),m=require("babel-core"),R=require("../../common/log/log.js"),S=require("./tools.js"),w=require("../../stores/projectStores.js"),E=require("../../config/config.js"),_=S.noBrowser.join(","),y=1,F={},O=!1;w.on("PROJECT_STORES_CHANGE_ES6",function(e,r){var t=e.hash;R.info("projectManager.js project "+t+" unable "+r),F[t].cache={}});var x=Object.assign({},d.prototype,{fileChange:function(e,r,t,n){this.emit("FILE_CHANGE",e,r,t,n)}});_exports={manager:x,getFile:o,getAllWXMLFileList:c,getAllJSFileList:s,getScripts:a,getAppJSONSync:p,getAppEntranceSync:u,getPageJSONSync:l}}var _exports;init(),module.exports=_exports;